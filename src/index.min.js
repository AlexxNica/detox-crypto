/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function m(c){var d;for(d=c.length-1;0<=d;--d){var g=d;++c[g];if(0!==c[g])break}}function k(c,d,g,e){function f(a){!a&&(a=null);if(!(this instanceof f))return new f(a);null===a&&(a=l(48));this.b=a;this.a=new Uint8Array(12)}function h(a,b){if(!(this instanceof h))return new h(a,b);a?(this.a=e.HandshakeState(n,e.constants.NOISE_ROLE_INITIATOR),this.a.Initialize(null,null,b)):(this.a=e.HandshakeState(n,e.constants.NOISE_ROLE_RESPONDER),this.a.Initialize(null,b))}f.prototype={get_key:function(){return this.b},
wrap:function(a){m(this.a);return g.encrypt(a,new Uint8Array(0),this.a,this.b,0)},unwrap:function(a){m(this.a);return g.decrypt(a,new Uint8Array(0),this.a,this.b,0)}};Object.defineProperty(f.prototype,"constructor",{enumerable:!1,value:f});h.prototype={ready:function(){return!this.a},get_handshake_message:function(){var a=null;this.a&&(this.a.GetAction()===e.constants.NOISE_ACTION_WRITE_MESSAGE&&(a=this.a.WriteMessage()),this.f());return a},f:function(){if(this.a.GetAction()===e.constants.NOISE_ACTION_SPLIT){var a=
this.a.Split();this.c=a[0];this.b=a[1];delete this.a}else if(this.a.GetAction()===e.constants.NOISE_ACTION_FAILED)throw delete this.a,Error("Noise handshake failed");},put_handshake_message:function(a){this.a&&(this.a.GetAction()===e.constants.NOISE_ACTION_READ_MESSAGE&&this.a.ReadMessage(a),this.f())},encrypt:function(a){return this.c.EncryptWithAd(new Uint8Array(0),a)},decrypt:function(a){return this.b.DecryptWithAd(new Uint8Array(0),a)},destroy:function(){this.a&&this.a.g();this.c&&this.c.g();
this.b&&this.b.g()}};Object.defineProperty(h.prototype,"constructor",{enumerable:!1,value:h});return{ready:function(a){function b(){--f;f||a()}var f=4;c.ready(b);d.ready(b);g.ready(b);e.ready(b)},create_keypair:function(a){!a&&(a=null);a||(a=c.createSeed());var b=c.createKeyPair(a);return{seed:a,ed25519:{"public":b.publicKey,"private":b.secretKey},x25519:{"public":d.convert_public_key(b.publicKey),"private":d.convert_private_key(a)}}},convert_public_key:function(a){return d.convert_public_key(a)},
sign:function(a,b,d){return c.sign(a,b,d)},verify:function(a,b,d){return c.verify(a,b,d)},Rewrapper:f,Encryptor:h}}var l;"object"===typeof exports?l=require("crypto").randomBytes:l=function(c){c=new Uint8Array(c);crypto.getRandomValues(c);return c};var n="Noise_NK_25519_ChaChaPoly_BLAKE2b";"function"===typeof define&&define.amd?define(["supercop.wasm","ed25519-to-x25519.wasm","aez.wasm","noise-c.wasm"],k):"object"===typeof exports?module.exports=k(require("supercop.wasm"),require("ed25519-to-x25519.wasm"),
require("aez.wasm"),require("noise-c.wasm")):this.detox_crypto=k(this.supercop_wasm,this.ed25519_to_x25519_wasm,this.aez_wasm,this.noise_c_wasm)}).call(this);